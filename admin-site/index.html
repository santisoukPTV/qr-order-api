<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด - Win Beef Noodle X Majedo Cafe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Phetsarath+OT:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body, h1, h2, h3, h4, h5, h6, button, input, select, textarea, span, p, div, a, th, td { 
            font-family: 'Phetsarath OT', 'Kanit', sans-serif; 
        }
        .main-content::-webkit-scrollbar, .order-column-content::-webkit-scrollbar, .modal-body::-webkit-scrollbar { width: 8px; }
        .main-content::-webkit-scrollbar-track, .order-column-content::-webkit-scrollbar-track, .modal-body::-webkit-scrollbar-track { background: #f1f1f1; }
        .main-content::-webkit-scrollbar-thumb, .order-column-content::-webkit-scrollbar-thumb, .modal-body::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        @keyframes slide-in-fade { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .new-order-card { animation: slide-in-fade 0.5s ease-out forwards; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar Navigation -->
            <aside class="w-64 bg-gray-800 text-white flex-shrink-0 flex flex-col">
                <div class="h-16 flex items-center justify-center bg-gray-900 px-4 text-center">
                     <h1 class="text-lg font-bold leading-tight">Win Beef Noodle X Majedo Cafe</h1>
                </div>
                <nav class="flex-1 px-2 py-4 space-y-2">
                    <a href="#dashboard" class="nav-link flex items-center px-4 py-2 rounded-md bg-gray-700"><i class="fas fa-tachometer-alt w-6"></i><span>แดชบอร์ดออเดอร์</span></a>
                    <a href="#menu" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-book-open w-6"></i><span>จัดการเมนู</span></a>
                    <a href="#reports" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-chart-line w-6"></i><span>รายงาน</span></a>
                    <a href="#settings" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-cog w-6"></i><span>ตั้งค่าร้าน</span></a>
                    <a href="#users" class="nav-link flex items-center px-4 py-2 rounded-md hover:bg-gray-700"><i class="fas fa-users-cog w-6"></i><span>จัดการพนักงาน</span></a>
                </nav>
                <div class="px-4 py-4 border-t border-gray-700">
                     <div class="flex items-center p-2">
                        <img class="h-10 w-10 rounded-full mr-3 object-cover" src="https://placehold.co/100x100/e2e8f0/333?text=SC" alt="User Avatar">
                        <div>
                            <p class="font-semibold">คุณสมชาย</p>
                            <p class="text-xs text-gray-400">เจ้าของร้าน</p>
                        </div>
                    </div>
                    <button id="logout-btn" class="w-full flex items-center justify-center mt-2 px-4 py-2 rounded-md text-sm text-red-300 hover:bg-red-500 hover:text-white transition-colors"><i class="fas fa-sign-out-alt w-6"></i><span>ออกจากระบบ</span></button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <header class="bg-white shadow-sm p-4 flex justify-between items-center flex-shrink-0">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800">แดชบอร์ดออเดอร์</h2>
                     <button id="mute-btn" class="text-gray-500 hover:text-gray-900 text-xl w-10 h-10 flex items-center justify-center rounded-full bg-gray-200"><i class="fas fa-volume-up"></i></button>
                </header>
                
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 main-content">
                    <div id="page-dashboard" class="page p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div id="page-menu" class="page hidden p-6"></div>
                    <div id="page-reports" class="page hidden p-6"></div>
                    <div id="page-settings" class="page hidden p-6"></div>
                    <div id="page-users" class="page hidden p-6"></div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- Modal Templates -->
    <template id="menu-item-modal-template">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform -translate-y-full opacity-0">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="modal-title text-2xl font-bold"></h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form class="modal-form">
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto modal-body">
                    <input type="hidden" name="id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">ชื่ออาหาร (ลาว/ไทย)</label><input type="text" name="name_th" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                        <div><label class="block text-sm font-medium">ชื่ออาหาร (อังกฤษ)</label><input type="text" name="name_en" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                    </div>
                    <div><label class="block text-sm font-medium">คำอธิบาย</label><textarea name="desc_th" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium">ราคา (กีบ)</label><input type="number" name="price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required min="0"></div>
                        <div><label class="block text-sm font-medium">หมวดหมู่</label><select name="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">URL รูปภาพ</label>
                        <input type="text" name="image" placeholder="https://example.com/image.jpg" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3">
                    <button type="button" class="close-modal-btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">บันทึก</button>
                </div>
            </form>
        </div>
    </template>

    <template id="user-modal-template">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform -translate-y-full opacity-0">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="modal-title text-2xl font-bold"></h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form class="modal-form">
                <div class="p-6 space-y-4 modal-body">
                    <input type="hidden" name="id">
                    <div><label class="block text-sm font-medium">ชื่อ-สกุล</label><input type="text" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">อีเมล</label><input type="email" name="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></div>
                    <div><label class="block text-sm font-medium">ตำแหน่ง</label><select name="role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required><option value="พนักงาน">พนักงาน</option><option value="เจ้าของร้าน">เจ้าของร้าน</option></select></div>
                </div>
                <div class="p-4 bg-gray-50 flex justify-end space-x-3">
                    <button type="button" class="close-modal-btn bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                    <button type="submit" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">บันทึก</button>
                </div>
            </form>
        </div>
    </template>
    
    <template id="confirm-modal-template">
         <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm transform -translate-y-full opacity-0">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                <h3 class="modal-title text-lg font-bold mb-2"></h3>
                <p class="modal-text text-sm text-gray-600"></p>
            </div>
            <div class="p-4 bg-gray-50 flex justify-center space-x-3">
                <button class="close-modal-btn bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">ยกเลิก</button>
                <button class="confirm-ok-btn bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700">ยืนยัน</button>
            </div>
        </div>
    </template>

    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Start Overlay -->
    <div id="start-overlay" class="fixed inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center z-50">
        <h2 class="text-3xl font-bold text-white mb-4">ຍິນດີຕ້ອນຮັບ</h2>
        <p class="text-white text-lg mb-8">ກົດປຸ່ມເພື່ອເລີ່ມຕົ້ນລະບົບຮັບອໍເດີ້</p>
        <button id="start-btn" class="bg-orange-500 text-white font-bold py-3 px-8 rounded-lg text-xl hover:bg-orange-600 transition-transform transform hover:scale-105">
            <i class="fas fa-play-circle mr-2"></i> ກົດເພື່ອເລີ່ມຕົ້ນ
        </button>
    </div>


    <script>
    // --- **สำคัญ** วาง Firebase Config ของคุณที่นี่ ---
    const firebaseConfig = {
      apiKey: "AIzaSyDKXi_uN7EccJ97LznJtlTU53XNW1UMR7o",
      authDomain: "foodcost-plus-app.firebaseapp.com",
      databaseURL: "https://foodcost-plus-app-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "foodcost-plus-app",
      storageBucket: "foodcost-plus-app.appspot.com",
      messagingSenderId: "202950628731",
      appId: "1:202950628731:web:73e5bc3b0ca769173519de"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // --- STATE & CONFIG ---
    const API_BASE_URL = 'https://qr-order-api.onrender.com';
    let mockCategories = [
        { id: 'drink', name_th: 'เครื่องดื่ม' }, { id: 'majedo_drink', name_th: 'เครื่องดื่ม Majedo' },
        { id: 'noodle', name_th: 'เส้น' }, { id: 'dessert', name_th: 'ของหวาน' },
        { id: 'main', name_th: 'อาหารจานหลัก' }, { id: 'appetizer', name_th: 'อาหารทานเล่น' },
        { id: 'others', name_th: 'อื่นๆ' },
    ];
    let mockUsers = [
        { id: 1, name: 'สมชาย ใจดี', role: 'เจ้าของร้าน', email: 'somchai.j@example.com' },
        { id: 2, name: 'สมหญิง รักงาน', role: 'พนักงาน', email: 'somyimg.r@example.com' },
    ];
    let userIdCounter = 3;
    let orders = [];
    let isMuted = true;
    let isToneStarted = false;
    const synth = new Tone.Synth().toDestination();
    const currencyFormatter = new Intl.NumberFormat('lo-LA', { style: 'currency', currency: 'LAK', minimumFractionDigits: 0, maximumFractionDigits: 0 });

    document.addEventListener('DOMContentLoaded', () => {
        const pageContainer = {
            dashboard: document.getElementById('page-dashboard'),
            menu: document.getElementById('page-menu'),
            reports: document.getElementById('page-reports'),
            settings: document.getElementById('page-settings'),
            users: document.getElementById('page-users'),
        };
        const modalContainer = document.getElementById('modal-container');
        const appContainer = document.getElementById('app-container');
        const startOverlay = document.getElementById('start-overlay');
        const startBtn = document.getElementById('start-btn');
        const muteBtn = document.getElementById('mute-btn');

        // --- GLOBAL UTILITIES ---
        function showModal(templateId, setupFunction) {
            const template = document.getElementById(templateId);
            if (!template) return;
            
            const modalWrapper = document.createElement('div');
            modalWrapper.className = 'modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0';
            modalWrapper.innerHTML = template.innerHTML;
            modalContainer.appendChild(modalWrapper);

            const close = () => modalContainer.removeChild(modalWrapper);
            modalWrapper.querySelectorAll('.close-modal-btn, .confirm-cancel-btn').forEach(btn => btn.addEventListener('click', close));
            modalWrapper.addEventListener('click', (e) => { if(e.target === modalWrapper) close(); });

            if (setupFunction) {
                setupFunction(modalWrapper);
            }

            setTimeout(() => {
                modalWrapper.classList.remove('opacity-0');
                modalWrapper.querySelector('.modal-content').classList.remove('-translate-y-full', 'opacity-0');
            }, 10);
        }

        // --- PAGE NAVIGATION ---
        function showPage(hash) {
            const pageName = hash.substring(1) || 'dashboard';
            const targetId = 'page-' + pageName;
            const targetTitle = document.querySelector(`a[href="${hash}"] span`)?.textContent || 'แดชบอร์ดออเดอร์';

            Object.values(pageContainer).forEach(p => p.classList.add('hidden'));
            document.getElementById(targetId)?.classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('bg-gray-700'));
            document.querySelector(`a[href="#${pageName}"]`)?.classList.add('bg-gray-700');
            document.getElementById('page-title').textContent = targetTitle;

            if (pageName === 'dashboard') setupOrderDashboard();
            if (pageName === 'menu') renderMenuPage();
            if (pageName === 'reports') renderReportsPage();
            if (pageName === 'settings') renderSettingsPage();
            if (pageName === 'users') renderUsersPage();
        }
        
        // --- ORDER DASHBOARD LOGIC (REAL-TIME) ---
        function setupOrderDashboard() {
            pageContainer.dashboard.innerHTML = `
                <div id="col-new" class="bg-white rounded-lg shadow-sm flex flex-col h-[85vh]"><div class="p-4 border-b rounded-t-lg bg-red-100"><h2 class="text-lg font-bold text-red-700 flex items-center"><i class="fas fa-receipt mr-2"></i>ออเดอร์ใหม่ (<span class="order-count">0</span>)</h2></div><div class="order-column-content flex-1 p-4 space-y-4 overflow-y-auto"></div></div>
                <div id="col-cooking" class="bg-white rounded-lg shadow-sm flex flex-col h-[85vh]"><div class="p-4 border-b rounded-t-lg bg-yellow-100"><h2 class="text-lg font-bold text-yellow-700 flex items-center"><i class="fas fa-fire-burner mr-2"></i>กำลังทำ (<span class="order-count">0</span>)</h2></div><div class="order-column-content flex-1 p-4 space-y-4 overflow-y-auto"></div></div>
                <div id="col-ready" class="bg-white rounded-lg shadow-sm flex flex-col h-[85vh]"><div class="p-4 border-b rounded-t-lg bg-blue-100"><h2 class="text-lg font-bold text-blue-700 flex items-center"><i class="fas fa-bell-concierge mr-2"></i>พร้อมเสิร์ฟ (<span class="order-count">0</span>)</h2></div><div class="order-column-content flex-1 p-4 space-y-4 overflow-y-auto"></div></div>
                <div id="col-completed" class="bg-white rounded-lg shadow-sm flex flex-col h-[85vh]"><div class="p-4 border-b rounded-t-lg bg-green-100"><h2 class="text-lg font-bold text-green-700 flex items-center"><i class="fas fa-check-circle mr-2"></i>เสร็จสิ้น (<span class="order-count">0</span>)</h2></div><div class="order-column-content flex-1 p-4 space-y-4 overflow-y-auto"></div></div>
            `;
            listenForOrders();
        }

        function listenForOrders() {
            db.collection("orders")
              .where("status", "in", ["new", "cooking", "ready", "completed"])
              .onSnapshot((snapshot) => {
                let newOrdersDetected = false;
                snapshot.docChanges().forEach((change) => {
                    const orderData = { id: change.doc.id, ...change.doc.data() };
                    const existingOrderIndex = orders.findIndex(o => o.id === orderData.id);

                    if (change.type === "added") {
                        if (existingOrderIndex === -1) {
                            orders.push(orderData);
                            newOrdersDetected = true;
                        }
                    } else if (change.type === "modified") {
                        if (existingOrderIndex > -1) {
                            orders[existingOrderIndex] = orderData;
                        }
                    } else if (change.type === "removed") {
                        if (existingOrderIndex > -1) {
                            orders.splice(existingOrderIndex, 1);
                        }
                    }
                });
                
                orders.sort((a, b) => (b.serverTimestamp?.toMillis() || 0) - (a.serverTimestamp?.toMillis() || 0));

                if (newOrdersDetected && !isMuted) {
                    synth.triggerAttackRelease("C5", "8n", Tone.now());
                }
                renderOrderDashboard();
            }, (error) => {
                console.error("Error listening for orders: ", error);
                pageContainer.dashboard.innerHTML = `<div class="col-span-4 text-center p-8 bg-red-100 text-red-800 rounded-lg">เกิดข้อผิดพลาดในการเชื่อมต่อกับฐานข้อมูล: ${error.message}</div>`;
            });
        }
        
        function renderOrderDashboard() {
            const statuses = ['new', 'cooking', 'ready', 'completed'];
            statuses.forEach(status => {
                const col = document.getElementById(`col-${status}`);
                if (!col) return;
                const colContent = col.querySelector('.order-column-content');
                const countSpan = col.querySelector('.order-count');
                
                colContent.innerHTML = '';
                const filteredOrders = orders.filter(o => o.status === status);
                countSpan.textContent = filteredOrders.length;
                
                filteredOrders.forEach(order => colContent.prepend(renderOrderCard(order)));
            });
            document.querySelectorAll('.action-btn').forEach(btn => btn.addEventListener('click', handleActionClick));
        }

        async function handleActionClick(e) {
            const orderId = e.target.dataset.orderId;
            const action = e.target.dataset.action;
            let newStatus = '';

            if (action === 'cook') newStatus = 'cooking';
            else if (action === 'ready') newStatus = 'ready';
            else if (action === 'complete') newStatus = 'completed';
            else if (action === 'cancel') {
                 showModal('confirm-modal-template', (modalWrapper) => {
                    modalWrapper.querySelector('.modal-title').textContent = 'ยืนยันการยกเลิก';
                    modalWrapper.querySelector('.modal-text').textContent = `คุณแน่ใจหรือไม่ว่าต้องการยกเลิกออเดอร์นี้?`;
                    modalWrapper.querySelector('.confirm-ok-btn').addEventListener('click', async () => {
                        await updateOrderStatus(orderId, 'cancelled');
                        modalContainer.innerHTML = '';
                    });
                });
                 return;
            } else {
                return;
            }
            
            await updateOrderStatus(orderId, newStatus);
        }

        async function updateOrderStatus(orderId, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                if (!response.ok) throw new Error('Failed to update status via API');
            } catch (error) {
                console.error("Error updating status:", error);
                alert('ไม่สามารถอัปเดตสถานะได้');
            }
        }

        function renderOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'order-card bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-md';
            if (order.status === 'new') card.classList.add('new-order-card', 'border-red-400');
            
            let actionButtonHtml = '';
            if (order.status === 'new') {
                actionButtonHtml = `<button data-order-id="${order.id}" data-action="cook" class="action-btn w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">เริ่มทำอาหาร</button>`;
            } else if (order.status === 'cooking') {
                actionButtonHtml = `<button data-order-id="${order.id}" data-action="ready" class="action-btn w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">พร้อมเสิร์ฟ</button>`;
            } else if (order.status === 'ready') {
                actionButtonHtml = `<button data-order-id="${order.id}" data-action="complete" class="action-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">เสิร์ฟแล้ว</button>`;
            }

            let cancelButtonHtml = '';
            if (order.status === 'new' || order.status === 'cooking') {
                 cancelButtonHtml = `<button data-order-id="${order.id}" data-action="cancel" class="action-btn mt-2 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">ยกเลิก</button>`
            }

            const time = order.serverTimestamp ? order.serverTimestamp.toDate().toLocaleTimeString('th-TH') : new Date(order.createdAt).toLocaleTimeString('th-TH');
            card.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="font-bold text-lg">โต๊ะ ${order.table}</span><span class="text-sm text-gray-500">${time}</span></div><div class="border-t my-2 py-2"><ul class="text-sm space-y-1">${order.items.map(i => `<li>${i.name} <span class="font-semibold">x${i.quantity}</span></li>`).join('')}</ul></div><div class="flex justify-between items-center mt-3"><span class="font-bold">ยอดรวม</span><span class="font-bold text-xl text-green-700">${currencyFormatter.format(order.total)}</span></div><div class="mt-4">${actionButtonHtml}${cancelButtonHtml}</div>`;
            return card;
        }

        // --- MENU MANAGEMENT LOGIC ---
        async function renderMenuPage() {
            pageContainer.menu.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold">จัดการเมนูอาหาร</h3>
                    <button id="add-menu-item-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 flex items-center"><i class="fas fa-plus mr-2"></i>เพิ่มรายการอาหาร</button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">รูปภาพ</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ชื่ออาหาร</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">หมวดหมู่</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ราคา</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">จัดการ</th></tr></thead><tbody id="menu-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/menu`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const menuItems = await response.json();

                const menuTableBody = pageContainer.menu.querySelector('#menu-table-body');
                menuTableBody.innerHTML = '';
                if (menuItems.length === 0) {
                    menuTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-500">กำลังโหลดข้อมูลเมนู...</td></tr>`;
                }
                menuItems.sort((a, b) => a.name_th.localeCompare(b.name_th, 'lo')).forEach(item => {
                    const category = mockCategories.find(c => c.id === item.category);
                    menuTableBody.innerHTML += `<tr>
                        <td class="px-6 py-4"><img src="${item.image}" alt="${item.name_th}" class="w-12 h-12 rounded-md object-cover"></td>
                        <td class="px-6 py-4"><div class="text-sm font-medium text-gray-900">${item.name_th}</div><div class="text-sm text-gray-500">${item.name_en}</div></td>
                        <td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">${category ? category.name_th : 'ไม่มี'}</span></td>
                        <td class="px-6 py-4 text-sm text-gray-800 font-semibold">${currencyFormatter.format(item.price)}</td>
                        <td class="px-6 py-4 text-right text-sm font-medium">
                            <button class="edit-btn text-indigo-600 hover:text-indigo-900" data-id="${item.id}">แก้ไข</button>
                            <button class="delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${item.id}">ลบ</button>
                        </td></tr>`;
                });
                pageContainer.menu.querySelector('#add-menu-item-btn').addEventListener('click', () => handleEditMenuItem());
                pageContainer.menu.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => handleEditMenuItem(e.target.dataset.id)));
                pageContainer.menu.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', (e) => handleDeleteMenuItem(e.target.dataset.id)));
            } catch (error) {
                console.error('Failed to fetch menu:', error);
                pageContainer.menu.querySelector('#menu-table-body').innerHTML = `<tr><td colspan="5" class="text-center p-6 text-red-500">ไม่สามารถโหลดข้อมูลเมนูได้</td></tr>`;
            }
        }
        
        async function handleEditMenuItem(id = null) {
            showModal('menu-item-modal-template', async (modalWrapper) => {
                const menuItemForm = modalWrapper.querySelector('.modal-form');
                const categorySelect = modalWrapper.querySelector('select[name="category"]');
                categorySelect.innerHTML = mockCategories.map(c => `<option value="${c.id}">${c.name_th}</option>`).join('');
                
                let item = null;
                if (id) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/menu`);
                        if (!response.ok) throw new Error('Failed to fetch menu for editing');
                        const menuItems = await response.json();
                        item = menuItems.find(i => i.id == id);
                    } catch(error) {
                        alert('ไม่สามารถโหลดข้อมูลสำหรับแก้ไขได้');
                        return;
                    }
                }
                modalWrapper.querySelector('.modal-title').textContent = item ? 'แก้ไขรายการอาหาร' : 'เพิ่มรายการอาหารใหม่';
                if (item) {
                    menuItemForm.querySelector('input[name="id"]').value = item.id;
                    menuItemForm.querySelector('input[name="name_th"]').value = item.name_th;
                    menuItemForm.querySelector('input[name="name_en"]').value = item.name_en;
                    menuItemForm.querySelector('textarea[name="desc_th"]').value = item.desc_th || '';
                    menuItemForm.querySelector('input[name="price"]').value = item.price;
                    menuItemForm.querySelector('select[name="category"]').value = item.category;
                    menuItemForm.querySelector('input[name="image"]').value = item.image;
                }
                menuItemForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const currentId = menuItemForm.querySelector('input[name="id"]').value;
                    const formData = new FormData(menuItemForm);
                    const newItemData = Object.fromEntries(formData.entries());
                    newItemData.price = parseFloat(newItemData.price);
                    
                    const url = currentId ? `${API_BASE_URL}/api/menu/${currentId}` : `${API_BASE_URL}/api/menu`;
                    const method = currentId ? 'PUT' : 'POST';
                    try {
                        const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newItemData) });
                        if (!response.ok) throw new Error('Failed to save item');
                        await renderMenuPage();
                        modalContainer.innerHTML = '';
                    } catch (error) {
                        alert('ไม่สามารถบันทึกข้อมูลได้');
                    }
                });
            });
        }

        async function handleDeleteMenuItem(id) {
            const response = await fetch(`${API_BASE_URL}/api/menu`);
            const menuItems = await response.json();
            const item = menuItems.find(i => i.id == id);
            showModal('confirm-modal-template', (modalWrapper) => {
                modalWrapper.querySelector('.modal-title').textContent = 'ยืนยันการลบ';
                modalWrapper.querySelector('.modal-text').textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบ "${item.name_th}"?`;
                modalWrapper.querySelector('.confirm-ok-btn').addEventListener('click', async () => {
                     try {
                        const response = await fetch(`${API_BASE_URL}/api/menu/${id}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete item');
                        await renderMenuPage();
                        modalContainer.innerHTML = '';
                    } catch (error) {
                        alert('ไม่สามารถลบข้อมูลได้');
                    }
                });
            });
        }

        // --- REPORTS PAGE LOGIC ---
        function renderReportsPage() {
            pageContainer.reports.innerHTML = `
                <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
                    <h3 class="text-2xl font-bold">รายงานยอดขาย</h3>
                    <div class="flex items-center bg-gray-200 rounded-lg p-1 text-sm">
                        <button class="time-filter-btn px-4 py-1.5 font-semibold text-white bg-gray-800 rounded-md" data-period="today">วันนี้</button>
                        <button class="time-filter-btn px-4 py-1.5 font-semibold text-gray-600 hover:bg-gray-300 rounded-md" data-period="yesterday">เมื่อวาน</button>
                        <button class="time-filter-btn px-4 py-1.5 font-semibold text-gray-600 hover:bg-gray-300 rounded-md" data-period="this_week">สัปดาห์นี้</button>
                        <button class="time-filter-btn px-4 py-1.5 font-semibold text-gray-600 hover:bg-gray-300 rounded-md" data-period="this_month">เดือนนี้</button>
                        <button class="time-filter-btn px-4 py-1.5 font-semibold text-gray-600 hover:bg-gray-300 rounded-md" data-period="custom">เลือกช่วงเวลา</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><i class="fas fa-sync-alt"></i></button>
                        <button class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center gap-2">
                            <i class="fas fa-download"></i> Download สรุป
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-md"><h4 class="text-gray-500">ยอดขายวันนี้</h4><p class="text-3xl font-bold mt-2">${currencyFormatter.format(3137500)}</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h4 class="text-gray-500">ออเดอร์วันนี้</h4><p class="text-3xl font-bold mt-2">85</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h4 class="text-gray-500">ลูกค้าใหม่</h4><p class="text-3xl font-bold mt-2">12</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-md"><h4 class="text-gray-500">ยอดขายเฉลี่ย/โต๊ะ</h4><p class="text-3xl font-bold mt-2">${currencyFormatter.format(112687)}</p></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md"><canvas id="salesChart"></canvas></div>`;
            
            const timeFilterBtns = pageContainer.reports.querySelectorAll('.time-filter-btn');
            timeFilterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    timeFilterBtns.forEach(b => {
                        b.classList.remove('bg-gray-800', 'text-white');
                        b.classList.add('text-gray-600', 'hover:bg-gray-300');
                    });
                    btn.classList.add('bg-gray-800', 'text-white');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-300');
                });
            });

            new Chart(document.getElementById('salesChart'), {
                type: 'bar',
                data: {
                    labels: ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัส', 'ศุกร์', 'เสาร์', 'อาทิตย์'],
                    datasets: [{ label: 'ยอดขาย (กีบ)', data: [2125000, 2300000, 2762500, 1950000, 3350000, 4625000, 4050000], backgroundColor: 'rgba(249, 115, 22, 0.6)', borderColor: 'rgba(249, 115, 22, 1)', borderWidth: 1 }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { callback: value => currencyFormatter.format(value) } } }, responsive: true }
            });
        }

        // --- SETTINGS PAGE LOGIC ---
        function renderSettingsPage() {
            pageContainer.settings.innerHTML = `
                <h3 class="text-2xl font-bold mb-6">ตั้งค่าร้านค้า</h3>
                <div class="bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700">ชื่อร้าน</label><input type="text" id="setting-store-name" value="Win Beef Noodle X Majedo Cafe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">สกุลเงิน</label><input type="text" value="LAK" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100" readonly></div>
                        <div><label class="block text-sm font-medium text-gray-700">จำนวนโต๊ะ</label><input type="number" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">อัตราภาษี (%)</label><input type="number" value="7" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></div>
                    </div>
                    <div class="mt-6 text-right"><button id="save-settings-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">บันทึกการเปลี่ยนแปลง</button></div>
                </div>`;
            document.getElementById('save-settings-btn').addEventListener('click', () => {
                alert('บันทึกการตั้งค่าแล้ว (จำลอง)');
            });
        }
        
        // --- USERS PAGE LOGIC ---
        function renderUsersPage() {
            pageContainer.users.innerHTML = `
                <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold">จัดการพนักงาน</h3><button id="add-user-btn" class="bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 flex items-center"><i class="fas fa-plus mr-2"></i>เพิ่มพนักงาน</button></div>
                <div class="bg-white shadow-md rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ชื่อ-สกุล</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">อีเมล</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ตำแหน่ง</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">จัดการ</th></tr></thead><tbody id="user-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>`;
            
            const userTableBody = pageContainer.users.querySelector('#user-table-body');
            userTableBody.innerHTML = mockUsers.map(user => `<tr><td class="px-6 py-4">${user.name}</td><td class="px-6 py-4">${user.email}</td><td class="px-6 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'เจ้าของร้าน' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span></td><td class="px-6 py-4 text-right"><button class="user-edit-btn text-indigo-600 hover:text-indigo-900" data-id="${user.id}">แก้ไข</button><button class="user-delete-btn text-red-600 hover:text-red-900 ml-4" data-id="${user.id}">ลบ</button></td></tr>`).join('');

            pageContainer.users.querySelector('#add-user-btn').addEventListener('click', () => handleEditUser());
            pageContainer.users.querySelectorAll('.user-edit-btn').forEach(b => b.addEventListener('click', e => handleEditUser(e.target.dataset.id)));
            pageContainer.users.querySelectorAll('.user-delete-btn').forEach(b => b.addEventListener('click', e => handleDeleteUser(e.target.dataset.id)));
        }

        function handleEditUser(id = null) {
            showModal('user-modal-template', (modalWrapper) => {
                const userForm = modalWrapper.querySelector('.modal-form');
                const user = id ? mockUsers.find(u => u.id == id) : null;
                modalWrapper.querySelector('.modal-title').textContent = user ? 'แก้ไขข้อมูลพนักงาน' : 'เพิ่มพนักงานใหม่';
                if (user) {
                    userForm.querySelector('input[name="id"]').value = user.id;
                    userForm.querySelector('input[name="name"]').value = user.name;
                    userForm.querySelector('input[name="email"]').value = user.email;
                    userForm.querySelector('select[name="role"]').value = user.role;
                }
                userForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const currentId = userForm.querySelector('input[name="id"]').value;
                    const userData = {
                        name: userForm.querySelector('input[name="name"]').value,
                        email: userForm.querySelector('input[name="email"]').value,
                        role: userForm.querySelector('select[name="role"]').value,
                    };
                    if (currentId) {
                        const index = mockUsers.findIndex(u => u.id == currentId);
                        mockUsers[index] = { ...mockUsers[index], ...userData };
                    } else {
                        mockUsers.push({ id: userIdCounter++, ...userData });
                    }
                    renderUsersPage();
                    modalContainer.innerHTML = '';
                });
            });
        }

        function handleDeleteUser(id) {
            const user = mockUsers.find(u => u.id == id);
            showModal('confirm-modal-template', (modalWrapper) => {
                modalWrapper.querySelector('.modal-title').textContent = 'ยืนยันการลบ';
                modalWrapper.querySelector('.modal-text').textContent = `คุณแน่ใจหรือไม่ว่าต้องการลบพนักงาน "${user.name}"?`;
                modalWrapper.querySelector('.confirm-ok-btn').addEventListener('click', () => {
                     mockUsers = mockUsers.filter(u => u.id != id);
                     renderUsersPage();
                     modalContainer.innerHTML = '';
                });
            });
        }

        // --- SOUND & INITIALIZATION ---
        startBtn.addEventListener('click', async () => {
            try {
                await Tone.start();
                isToneStarted = true;
                isMuted = false;
                muteBtn.querySelector('i').className = 'fas fa-volume-up';
                console.log('Audio context started successfully.');
                startOverlay.style.display = 'none';
                appContainer.classList.remove('hidden');
                showPage(window.location.hash || '#dashboard');
            } catch (e) {
                console.error('Could not start audio context', e);
                alert('ไม่สามารถเปิดใช้งานเสียงได้ กรุณาลองรีเฟรชหน้าเว็บ');
            }
        });

        muteBtn.addEventListener('click', () => {
            if (!isToneStarted) return;
            isMuted = !isMuted;
            muteBtn.querySelector('i').className = `fas ${isMuted ? 'fa-volume-mute' : 'fa-volume-up'}`;
        });
        
        window.addEventListener('hashchange', () => showPage(window.location.hash));
    });
    </script>
</body>
</html>
